<!DOCTYPE html>
<head>
	<title>Магия остатков</title>
    <meta name="description" content="Сайт, рисующий магия">
    <meta name="author" content="Vasa">	
    <link rel="icon" type="image/png" href="mod.png"/>
	<script type="text/javascript" src="lib/Chart.bundle.min.js"></script>
	<script type="text/javascript" src="js/diagrams.js"></script>
	<script type="text/javascript" src="js/map.js"></script>
	<script type="text/javascript" src="js/reproduction.js"></script>
</head>

<body>
	<style>
		.main{
			display: grid;
			grid-template-columns: 2fr 1fr 2fr;
		}
		div{
			padding: 2px;
		}
	</style>

	<div class="main" >
		<div class="picture"  onclick = "checkLinePointer(event);">
			<canvas id="draw" width="600" height="600">
				Этот элемент не поддерживается
			</canvas>
		</div>
		<div>
			<div>
				<div>Размер<input type="number" id="n" value="100" min="50" max="600" /></div>
				<div><input type="submit" value="Создать" onclick="begin();" /></div>
			</div>
			<div><input type="submit" value="Ход" onclick="nextStep(); drawChart();" /></div>
			<div><input type="submit" value="Поехали" onclick="run();" /></div>
			<div><input type="submit" value="Стопэ" onclick="stop();" /></div>
			<div>
				<div>
				<input type="radio" id="type0" name="radio" value="type0" checked onchange="drawing()"/>
				<label for="type0">Растения</label>
				</div>
				<div>
				<input type="radio" id="type1" name="radio" value="type1"  onchange="drawing()"/>
				<label for="type1">Водичка</label>
				</div>
				<div>
				<input type="radio" id="type2" name="radio" value="type2" onchange="drawing()" />
				<label for="type2">Минеральные вещества</label>
				</div>
				<div>
				<input type="radio" id="type3" name="radio" value="type3" onchange="drawing()" />
				<label for="type3">Возрасты</label>
				</div>
			</div>
			<div id = "data">
				Значения
			</div>
		</div>
		<div>
			<canvas id="allChart" width="500" height="300"></canvas>
			<canvas id="cntChart" width="500" height="300">			</canvas>
			<canvas id="greenChart" width="500" height="300">			</canvas>
		<!--	<canvas id="distanceChart" width="500" height="300">			</canvas> -->
			<canvas id="childrenChart" width="500" height="300">			</canvas>
			<canvas id="energyChart" width="500" height="300">			</canvas>
			<canvas id="ageChart" width="500" height="300">			</canvas>
			<canvas id="years" width="500" height="300">			</canvas>
		</div>
	</div>
	
	<script>
		
		const begin = () => {
			let nValue = document.getElementById('n').value;
			if (Number(nValue) == NaN){
				nValue = 100
			}
			else {
				nValue = Number(nValue)
				if (nValue < 50) nValue = 50;
				if (nValue > 600) nValue = 600;
			}
			n = nValue;
			m = n;
			cell = size / n; 

			create();
		}

		const checkLinePointer = (event) => {
			let x = Math.floor(event.layerX / cell)
			let y = Math.floor(event.layerY / cell)
			console.log(arr[n * x + y])
		}

		const size = 600;

		let n = 100;
		let m = n;

		let cell = size / n; 

		const reproductionLimit = 128;
		const reproductionEnergy = 32;
		const locationSearchEnergy = 16;
		const mutationProbability = 1/50
		const energySoil = 9;
		const energyCost = 20;
		const maxGreen = 255;
		const fertilizer = 10;

		let sunPhase = 1;
		let dSun = -0.1;
	
		let rainPhase = -10;
		let dRain = 2;

		let arr = [];

		let cntPlants = []
		let greenPlants = []
		let redPlants = []
		let distancePlants = []
		let distanceSearchPlants = []
		let childrenPlants = []
		let fertilityPlants = []
		let locationSearchPlants = []
		let energyPlants = []
		let energyPlantsMax = []
		let soilEfficiencyPlants = []
		let agePlants = []
		let years = []
		let year = 0;
		let newInterval = null;

		const run = () => newInterval = setInterval(nextStep, 500)
		const stop = () => clearInterval(newInterval)

		const getSoilEnergy = (cell, plant) => {
			let energy = Math.min(energySoil * plant.soilEfficiency, energySoil * cell.soilFertility)
			cell.soilFertility = Math.max(cell.soilFertility - plant.soilEfficiency, 0)
			return energy
		}

		const nextStep = (drawing = true) => {
			for (let i = 0; i < n * m; i++){
				if (arr[i].plant) {
					let plant = arr[i].plant
					if (plant.active) {				
							plant.age++;
							let age = plant.age;
							let dWater =  255 - plant.red - arr[i].water 
							dWater = dWater > 0 ? dWater : 0
							let soilEnergy = getSoilEnergy(arr[i], plant)
							
							plant.energy += (
								sunPhase * Math.pow(plant.green, 2) / Math.pow(maxGreen, 1)
								+ soilEnergy
								- Math.pow(plant.red, 1) / 4
								- Math.pow(age, 2/3) 
								- Math.pow(plant.distance, 2) 
								- Math.pow(dWater, 2)
								- Math.pow(plant.energyMax, 6/14) 
								- Math.pow(plant.fertility, 2)
								- Math.pow(plant.soilEfficiency, 2) / 3
								- energyCost)

							if (plant.energy > plant.energyMax) plant.energy = plant.energyMax

							if (plant.red < 255 - arr[i].water) {
								plant.energy = -1
							}
							
							if ( ( true || plant.energy > reproductionLimit) && Rand(0, 16) < plant.fertility && plant.age > 1){
								for (let k = 0; k < plant.children && plant.energy > 0; k++) {
									reproduction( Math.floor(i / n), i % m, plant)
									plant.energy -= (reproductionEnergy + plant.locationSearch * locationSearchEnergy)   
								}
							}
							if (plant.energy < 0){
								delete plant
								arr[i] = {type : 0, r : 0, g: 0, b : 0, water : arr[i].water, 
									soilFertility : Math.min(arr[i].soilFertility + 20	, 255) }
							}  
						}
				}
			}

			for (let i = 0; i < n * m; i++){
				if (arr[i].plant) {
					arr[i].plant.active = true
				}	

				arr[i].soilFertility = Math.min(arr[i].soilFertility + fertilizer, 255)  

				arr[i].water += rainPhase
				if (arr[i].water > 255) arr[i].water = 255
				if (arr[i].water < 0) arr[i].water = 0
			}

			sunPhase += dSun
			
			if (sunPhase < 0.2) dSun = 0.1
			if (sunPhase > 0.9) dSun = -0.1

			rainPhase += dRain
			if (rainPhase < -9) dRain = 2
			if (rainPhase > 9)  dRain = -2

			return draw(arr, drawing)
		}

		function Rand(min, max)
		{
			let d = max - min;
			return Number((max - d*Math.random()).toFixed(2));
 		}

 		//create();
			
	const iterations = (count) => {
		for (let i = 0; i < count; i++){
			nextStep(false)
		}
		draw(arr)
		drawChart()
	}
		 
	</script>
</body>
